---
title: "Tier Classification with Random Forests and KNN Machine Learning"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

```{r, message=FALSE, echo=FALSE}
library(tidyverse)
library(gridExtra)
library(caret)
library(fmsb)
create_beautiful_radarchart <- function(data, color = "#00AFBB", 
                                        vlabels = colnames(data), vlcex = 0.7,
                                        caxislabels = NULL, title = NULL, ...){
  radarchart(
    data, axistype = 1,
    # Customize the polygon
    pcol = color, pfcol = scales::alpha(color, 0.5), plwd = 2, plty = 1,
    # Customize the grid
    cglcol = "grey", cglty = 1, cglwd = 0.8,
    # Customize the axis
    axislabcol = "grey", 
    # Variable labels
    vlcex = vlcex, vlabels = vlabels,
    caxislabels = caxislabels, title = title, ...
  )
}
```

This file contains an exploration of the classification analysis for Pick/Ban Rate, Win Rate, and KDA, as attempts to predict Tier. 

```{r, message=FALSE}


leaguedf <- read_csv('../data_sets/S13LeagueOfLegendsData.csv', col_types=cols()) %>% 
  rename(winr = "Win %", pick = 'Pick %', ban = 'Ban %') %>%
  mutate(pbr = pick + ban) %>%
  select(-c(1,2,6,7,10,11))


head(leaguedf, 5)
```
#### Key for Reference
- Tier: Tier of champion
- winr: winrate of champion
- KDA: Kill/Death/Assist Ratio, $\frac{\texts{kills} + \text{assists}}{\text{deaths}}$
- pbr: Pick Ban Rate, Pick rate + Ban rate
- Class: Class of fighter, categorical choice
- ROLE: role that data was collected for
- Role %: Percentage of games that were played for this champion on this role
- patch: Patch that data was collected from


```{r}

leaguedf$Tier <- factor(leaguedf$Tier, levels=c('D', 'C', 'B', 'A', 'S', 'God'), ordered=TRUE)
plot1 <- ggplot(data=leaguedf) + 
  geom_boxplot(mapping = aes(x = Tier, y=winr, fill=Tier)) +
  ggtitle('Win Rate and Tier') +
  ylab('Win Rate') + 
  theme(legend.position='none') +
  scale_fill_brewer(palette="BuPu")

plot2 <- ggplot(data = leaguedf) + 
  geom_boxplot(mapping = aes(x= Tier, y=pbr, fill=Tier)) +
  ggtitle('Pick/Ban Rate and Tier') +
  ylab('Pick/Ban Rate') + 
  theme(legend.position='none') + 
  scale_fill_brewer(palette="Dark2")
  
  
grid.arrange(plot1, plot2, ncol=2)


```



```{r}
ggplot(data=leaguedf) + 
  geom_bar(mapping=aes(x=Tier, fill=Tier)) + 
  scale_fill_brewer('viridis') + 
  theme(legend.position = 'none') + ylab("Number of Observations") 

```

```{r}
tier_stats <- leaguedf %>%
  group_by(Tier) %>% 
  summarize(KDA = median(KDA), pbr = median(pbr), wr=median(winr))
tier_stats$Tier <-  factor(tier_stats$Tier, levels=c('D', 'C', 'B', 'A', 'S', 'God'), ordered=TRUE)
tier_stats <- as_tibble(tier_stats) %>% column_to_rownames(var = "Tier") 
  # statistics wanted by tier, and change row name to tier

max_min <- data.frame(KDA = c(0, 5), pbr=c(0,1), wr=c(0,1)) #Formatting data for radar chart
rownames(max_min) <- c("Max", "Min")

radar_frame <- rbind(max_min, tier_stats) #final frame for radar chart

#The next two lines split the area for the radar charts
op <- par(mar = c(1.5,1.5,1.5,1.5)) 
#Split into 6 pieces
par(mfrow = c(2,3))

#Color for each tier
colors = c("#D95F45", "#D9B245", "#62D945", "#45D9AA", "#45A6D9", "#7145D9")

#Title for each chart
titles = c("A", "B", "C", "D", "S", "God")

#make them
for (i in 1:6) {
  create_beautiful_radarchart(data = radar_frame[c(1,2, i+2), ],
                              color = colors[i], title = titles[i]
                              )
} #TODO: FIgure out why its wrong
par(op)
```

p.s. I think spider plot is cooler name than radar chart.

## Thoughts

- For higher tiers, such as God, S, and A, it seems that pick ban rate significantly rises.
- For lower tiers, such as D and C, the win rate significantly drops.
- Alone, each of them would likely only do so well to analyze the tiers, but together they seem to be better.
- The number of observations is fairly symmetric with respect to the middle (A/B)

## Moving Forwards
From here on, we will begin classification techniques. The data is overall fairly symmetric with respect to the 


```{r}
set.seed(27)

# Split the data into test/train. We want 75% for training, and 25% for testing.

inTrain <- createDataPartition(y=leaguedf$Tier, p=0.75, list=FALSE) 

leagueTrain <- leaguedf[ inTrain, ]
leagueTest <- leaguedf[ -inTrain, ]

#Verify we did it correct, 0.75*5637 is approx 4225
nrow(leagueTrain)
```
```{r, eval=TRUE, echo=FALSE}
rf_fit <- readRDS('rf_initial_fit.rds')
```


```{r, eval=FALSE}

rf_fit <- train(as.factor(Tier) ~ .,
                data = leagueTrain,
                method="ranger")

rf_fit
```

```{r, echo=FALSE, eval=FALSE}
saveRDS(rf_fit, "rf_initial_fit.rds")
```

```{r}
rf_pred <- predict(rf_fit, leagueTest)

cm <- confusionMatrix(rf_pred, as.factor(leagueTest$Tier), dnn = c("Prediction", "Actual"))
plt <- as.data.frame(cm$table)
plt$Prediction <- factor(plt$Prediction, levels=rev(levels(plt$Prediction)))

ggplot(plt, aes(Prediction,Actual, fill=Freq)) +
        geom_tile() + geom_text(aes(label=Freq)) +
        scale_fill_gradient(low="white", high="#009194") +
        labs(x = "Actual",y = "Prediction") +
        scale_y_discrete(labels=c('D', 'C', 'B', 'A', 'S', 'God')) +
        scale_x_discrete(labels=c('God', 'S', 'A', 'B', 'C', 'D'))


```

```{r, eval=FALSE}
Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

Boundarydf = expand.grid(winr = seq(0.4, 0.6, length.out=50), pbr = seq(0, 1, length.out=50), KDA = seq(1, 5, length.out=40), Role = "SUPPORT", `Role %` = seq(0.1,1, length.out=10), Patch=c("13_12"), Class=c("Mage", "Support"))
Boundarydf$Tier <- predict(rf_fit, Boundarydf)
Boundarydf <- Boundarydf %>%
  group_by(winr, pbr) %>%
  summarize(Tier = Mode(Tier)) %>%
  ungroup()

write.csv(Boundarydf, "BoundaryFrame.csv")


```
```{r, echo=FALSE}
Boundarydf <- read_csv("BoundaryFrame.csv")
```

```{r, eval=TRUE}


leaguedf %>% filter(Role=="SUPPORT", Patch=="13_12", Class == "Mage" | Class == "Support") %>%
  ggplot(mapping=aes(x=winr, y=pbr, fill= Tier)) + geom_raster(data=Boundarydf, alpha=0.5) + geom_point(shape=21, mapping=aes(size=KDA), alpha=0.75) + theme_minimal() + xlab('Win Rate') + ylab('Pick Ban Rate') + ggtitle('Boundary Plot for Support in Patch 13.12')

```



- From the boundary plot and confusion matrix, we can see our model is pretty good at sorting through God, S, and A tiers, but worse at B and C.
- We can tell from the boundary plot that Pick Ban Rate is very important in telling whether or not a champion is god tier, since almost all of the area above 50% pick ban rate is designated to God Tier.


### Preprocessing Data
- TODO: 
  - Discretize PBR/Wr
  - Turn Patch from categorical to numeric for <= comparisons
  - ??
```{r}
```

### Hypertuning Model on Preprocess Data
This will take a long time, so please be patient if you run this yourself.
```{r, echo=FALSE}
fit <- readRDS("RangerFITwPatch.rds")
```

```{r, eval=FALSE}

grid <- expand.grid(mtry = c(6,12,18,24,30,36), splitrule=c("extratrees", "gini"), min.node.size=c(1,10,25,40,50))

fitControl <- trainControl(method='CV', number = 5, verboseIter=FALSE)

fit <- train(as.factor(Tier)~.,
             data=leagueTrain,
             method="ranger",
             tuneGrid=grid,
             trControl = fitControl, importance="impurity"
)
saveRDS(fit, "RangerFITwPatch.rds")

```


```{r}
print(fit)
```

### Recreation of Charts

```{r}
ggplot(varImp(fit), mapping=aes(x=reorder(variable, importance), y=importance, fill=importance)) + geom_bar(stat = "identity", position = "dodge")  +
    ylab("Variable Importance") +
    xlab("") +
    ggtitle("Information Value Summary") +
    guides(fill = "none") +
    scale_fill_gradient(low = "red", high = "blue")


```
```{r}



```


