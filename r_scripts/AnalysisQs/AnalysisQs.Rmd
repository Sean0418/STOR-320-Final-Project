---
title: "Analysis on Document Questions"
date:  "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(patchwork)
library(gganimate)
library(plotly)
library(reshape2)
```

```{r}
leaguedf <- read_csv('../../data_sets/S13LeagueOfLegendsData.csv', 
                      col_types=c('c', 'c', 'c', 'c', 'c', 'd', 'd', 'd', 'd', 'd', 'd', 'd', 'c'), 
                      col_names=c('rowno', 'Name', 'Class', 'Role', 'Tier', 'Score', 'Trend', "WinRate", "RoleRate", "PickRate", "BanRate", 'KDA', 'Patch'), skip=1) %>%
  column_to_rownames("rowno") %>% 
  mutate(PickBanRate = PickRate + BanRate, Patch = as.numeric(str_replace(Patch, '(.*?)_(.*?)', ''))) %>%
  select(-c(PickRate, BanRate)) 


stats <- leaguedf %>% group_by(Name) %>%
  summarize(sdWinRate = sd(WinRate), sdPickBanRate = sd(PickBanRate))
leaguedf <- inner_join(stats, leaguedf, 'Name')

leaguedfRole <- leaguedf %>%
  mutate(Role = case_when(Role == "ADC" ~ "Attack Damage Carry", TRUE ~ str_to_title(Role)))
```

```{r}
#SD by patch
Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

leaguedfRole %>%
  group_by(Name) %>% filter(Class != "NULL") %>%
  ggplot() + geom_point(mapping=aes(x=sdWinRate, y=sdPickBanRate, color = Class)) + facet_wrap(~ Role) + xlab("Standard Deviation of Win Rate") + ylab("Standard Deviation of Pick Ban Rate") + ggtitle("Volatility of Champions")
```


```{r, fig.height = 8}

#Win rate and Pick Ban Rate over time seperated by Role
PatchRoleStats <- leaguedfRole %>% filter(Role != "Jungle") %>%
  group_by(Role, Patch) %>%
  summarize(meanWinRate = mean(WinRate), meanPBRate = mean(PickBanRate),.groups='keep')

plot1a <- leaguedfRole %>% filter(Role != "Jungle") %>%
  ggplot() + geom_line(mapping=aes(x=Patch, y=WinRate, color=Name, alpha=0.001)) +
  geom_line(data = PatchRoleStats, mapping = aes(x=Patch, y=meanWinRate), color="black")+ 
  theme(legend.position="none") + facet_wrap( ~ Role) + ggtitle("Win Rate over Time seperated by Role") + xlab('') + ylab("")

plot1b <- leaguedfRole %>% filter(Role != "Jungle") %>%
  ggplot() + 
  geom_line(mapping=aes(x=Patch, y=PickBanRate, color=Name, alpha=0.001)) + 
  geom_line(data = PatchRoleStats, mapping=aes(x=Patch, y=meanPBRate), color="black") + 
  theme(legend.position="above") + facet_wrap( ~ Role) + ggtitle("PBRate over Time Seperated by Role") + xlab('') + ylab("")
#Win Rate and Pick Ban Rate over Time for just Heimerdinger seperated by Role
plot2a <- leaguedfRole %>% filter(Name == "Heimerdinger") %>%
  ggplot() + geom_line(mapping = aes(x = Patch, y = WinRate, alpha=0.5), color="green") + 
  geom_line(data = PatchRoleStats, mapping=aes(x=Patch, y=meanWinRate), color="black") + 
  facet_wrap(~ Role) + theme(legend.position="none") + xlab("Patch") + ylab("")

plot2b <- leaguedfRole %>% filter(Name == "Heimerdinger") %>%
  ggplot() + geom_line(mapping = aes(x = Patch, y = PickBanRate), color="green") + 
  geom_line(data = PatchRoleStats, mapping=aes(x=Patch, y=meanPBRate), color="black") + 
  facet_wrap("Role") + theme(legend.position="none") + scale_x_discrete("Patch", labels = 1:24) + ylab('')


patched <- (plot1a & plot1b) / (plot2a & plot2b)
patched
```

Is this useful?????? What do you gain from it??

```{r, warning = F}
#Covariation of PBR for champions.

Spread_Data <- leaguedf %>% 
  pivot_wider(id_cols = c('Name', 'Role'), names_from='Patch', values_from='PickBanRate') %>%
  mutate(ID = paste(Name, Role, sep='.')) %>%
  select(-c(1,2)) %>%
  na.omit()

NameList = Spread_Data$ID

Spread_Data <- as_tibble(t(Spread_Data)) %>%
  filter(row_number() <= n() - 1) %>%
  mutate_if(is.character, as.numeric)

colnames(Spread_Data) <- NameList
CorrMat <- as_tibble(cor(Spread_Data))
rownames(CorrMat) <- colnames(CorrMat)

df <- CorrMat %>% rownames_to_column(var = "Champion1") %>% select(Senna.SUPPORT, `Tahm Kench.SUPPORT`, Ashe.ADC, Champion1) %>%
  gather(key = "Champion", value = "Correlation", -Champion1) %>%
  mutate(label = case_when(
    TRUE ~ as.character(NA)
  )) %>%
  filter(Correlation < 1)

ggplot(data = df, mapping = aes(x=Champion, y = Correlation)) + 
  geom_boxplot() + 
  ylab("Pick Ban Rate Correlation") + 
  ggtitle("PBR Correlation Boxplot") + 
  geom_text(aes(label = label), na.rm = TRUE, hjust = -0.1, size = 3) + 
  scale_x_discrete(name = c("Ashe ADC", "Senna Support", "Tahm Kench Support"))
```

```{r, eval=FALSE}
p <- leaguedf %>%
  select("Name", "PickBanRate", "WinRate", "Role", "RoleRate", "Class", "Patch") %>% 
  filter(!(Class == "NULL")) %>%
  ggplot() + geom_point(mapping= aes(x = PickBanRate, y = WinRate, size=RoleRate, color=Class)) + 
  facet_wrap(~ Role) + xlab("Pick Ban Rate") + ylab("Win Rate")
gif <- p + transition_states(Patch, 
                             transition_length = 3, 
                             state_length= 1) + 
  labs(title = "Patch: {closest_state}")
anim <- animate(gif, fps = 30, nframes = 480)
anim
```

```{r, echo= FALSE}
annotations = list( 
  list( 
    x = 0.015,  
    y = 1.0,  
    text = "ADC",  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ),  
  list( 
    x = 0.3925,  
    y = 1,  
    text = "Jungle",  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ),  
  list( 
    x = 0.715,  
    y = 1,  
    text = "Mid",  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ),
  list( 
    x = 0.0375,  
    y = 0.46,  
    text = "Support",  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ), 
  list( 
    x = 0.38,  
    y = 0.46,  
    text = "Top",  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ))
```

```{r, fig.height=6, fig.width=8, message = FALSE, warning = FALSE}
leaguedf %>%
  select("Name", "PickBanRate", "WinRate", "Role", "RoleRate", "Class", "Patch") %>%
  filter(!(Class == "NULL")) %>%
  group_by(Role) %>%
  group_map( ~ plot_ly(data = .,
      x = ~ PickBanRate,
      y = ~ WinRate,
      color = ~ Class,
      text = ~ Name,
      frame = ~ Patch, 
      hoverinfo = "text",
      type = "scatter",
      mode = "markers", 
      marker = list(size = ~ RoleRate*5)
      ), .keep = TRUE) %>%
  subplot(nrows = 2, shareX = TRUE, shareY=TRUE, margin=0.03) %>%
  layout(showlegend = FALSE, title = 'Pick Ban Rate vs. Win Rate by Patch seperated by Role',
         plot_bgcolor='#e5ecf6', 
         xaxis = list( 
           zerolinecolor = '#ffff', 
           zerolinewidth = 2, 
           gridcolor = 'ffff'), 
         yaxis = list( 
           zerolinecolor = '#ffff', 
           zerolinewidth = 2, 
           gridcolor = 'ffff'),
         margin = 0.07) %>%
  layout(annotations = annotations)
```


```{r, echo = F}
library(caret)
```

```{r, fig.height = 10}
corr_data <- leaguedf %>%
  select(c("WinRate", "Role", "KDA")) %>%
  pivot_wider(names_from = Role,
              values_from = Role,
              values_fn = function(x) TRUE,
              values_fill = FALSE)

model <- nls(WinRate ~ a*KDA + b*TOP*KDA^2 + c*MID*KDA^2 + d*JUNGLE*KDA^2 + e*SUPPORT*KDA^2 + f*ADC*KDA^2 + g, data = corr_data, start = list(a = 0.01, b = 0.01, c = 0.01, d = 0.01, e = 0.01, f = 0.01, g = 0.4))

predict_wr <- function(kda, top, mid, jungle, support, adc) {
  predict(model, newdata = data.frame(KDA = kda, TOP = top, MID = mid, JUNGLE = jungle, SUPPORT = support, ADC = adc))
}

train_control <- trainControl(method = "repeatedcv", number = 25, repeats = 5)
nls1 <- train(WinRate ~ predict_wr(KDA, TOP, MID, JUNGLE, SUPPORT, ADC), data = corr_data,
                                         method = "lm", 
                                         trControl = train_control,
                                         preProcess = c("center", "scale"))

summary(nls1) 
summary(model)
```

```{r, fig.height = 10, fig.width =}

corr_data <- corr_data %>%
  mutate(pred = predict(nls1, .))

MidGrid <- expand.grid(KDA = seq(0,5, length.out = 501), MID = c(TRUE), TOP = FALSE, ADC = FALSE, SUPPORT = FALSE, JUNGLE = FALSE)
MidGrid$WinRate <- predict(nls1, MidGrid)
JungleGrid <- expand.grid(KDA = seq(0,5, length.out = 501), MID = FALSE, TOP = FALSE, ADC = FALSE, SUPPORT = FALSE, JUNGLE = TRUE)
JungleGrid$WinRate <- predict(nls1, JungleGrid)
TopGrid <- expand.grid(KDA = seq(0,5, length.out = 501), MID = FALSE, TOP = T, ADC = FALSE, SUPPORT = FALSE, JUNGLE = FALSE)
TopGrid$WinRate <- predict(nls1, TopGrid)
ADCGrid <- expand.grid(KDA = seq(0,5, length.out = 501), MID = F, TOP = FALSE, ADC = T, SUPPORT = FALSE, JUNGLE = FALSE)
ADCGrid$WinRate <- predict(nls1, ADCGrid)
SupportGrid <- expand.grid(KDA = seq(0,5, length.out = 501), MID = F, TOP = FALSE, ADC = FALSE, SUPPORT = T, JUNGLE = FALSE)
SupportGrid$WinRate <- predict(nls1, SupportGrid)

plot1a <- corr_data %>% filter(MID == TRUE) %>%
  ggplot(mapping = aes(x = KDA, y = WinRate)) + 
  geom_point(alpha = 0.1) + 
  geom_line(data = MidGrid, mapping = aes(x = KDA, y = WinRate), color = "blue") + 
  ggtitle("Mid") 

plot1b <- corr_data %>% filter(ADC == TRUE) %>%
  ggplot(mapping = aes(x = KDA, y = WinRate)) + 
  geom_point(alpha = 0.1) + 
  geom_line(data = ADCGrid, mapping = aes(x = KDA, y = WinRate), color = "red")+ 
  ggtitle("ADC")

plot1c <- corr_data %>% filter(SUPPORT == TRUE) %>%
  ggplot(mapping = aes(x = KDA, y = WinRate)) + 
  geom_point(alpha = 0.1) + 
  geom_line(data = SupportGrid, mapping = aes(x = KDA, y = WinRate), color = "green") + 
  ggtitle("Support")

plot2a <- corr_data %>% filter(JUNGLE== TRUE) %>%
  ggplot(mapping = aes(x = KDA, y = WinRate)) + 
  geom_point(alpha = 0.1) + 
  geom_line(data = JungleGrid, mapping = aes(x = KDA, y = WinRate), color = "purple") + 
  ggtitle("Jungle")

plot2b <- corr_data %>% filter(TOP == TRUE) %>%
  ggplot(mapping = aes(x = KDA, y = WinRate)) + 
  geom_point(alpha = 0.1) + 
  geom_line(data = TopGrid, mapping = aes(x = KDA, y = WinRate), color = "orange") + 
  ggtitle("Top")

pw <- (plot1a & plot1b) / (plot1c) / (plot2a & plot2b) 

pw
```



```{r}
MidGrid <- expand.grid(KDA = seq(0,5, length.out = 501), MID = c(TRUE), TOP = FALSE, ADC = FALSE, SUPPORT = FALSE, JUNGLE = FALSE)
MidGrid$WinRate <- predict(nls1, MidGrid)

plot1a <- corr_data %>% filter(MID == TRUE) %>%
  ggplot(mapping = aes(x = KDA, y = WinRate)) + 
  geom_point(alpha = 0.1) + 
  geom_line(data = MidGrid, mapping = aes(x = KDA, y = WinRate), color = "blue") + 
  ggtitle("Mid") 


plot1a
```