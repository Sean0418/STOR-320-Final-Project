---
title: "Analysis on Document Questions"
date:  "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(patchwork)
library(gganimate)
library(plotly)
```

```{r}
leaguedf <- read_csv('../../data_sets/S13LeagueOfLegendsData.csv', 
                      col_types=c('c', 'c', 'c', 'c', 'c', 'd', 'd', 'd', 'd', 'd', 'd', 'd', 'c'), 
                      col_names=c('rowno', 'Name', 'Class', 'Role', 'Tier', 'Score', 'Trend', "WinRate", "RoleRate", "PickRate", "BanRate", 'KDA', 'Patch'), skip=1) %>%
  column_to_rownames("rowno") %>% 
  mutate(PickBanRate = PickRate + BanRate, Patch = as.numeric(str_replace(Patch, '(.*?)_(.*?)', ''))) %>%
  select(-c(PickRate, BanRate)) 


stats <- leaguedf %>% group_by(Name) %>%
  summarize(sdWinRate = sd(WinRate), sdPickBanRate = sd(PickBanRate))
leaguedf <- inner_join(stats, leaguedf, 'Name')

leaguedfRole <- leaguedf %>%
  mutate(Role = case_when(Role == "ADC" ~ "Attack Damage Carry", TRUE ~ str_to_title(Role)))
```

```{r}
#SD by patch
Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

leaguedfRole %>%
  group_by(Name) %>% filter(Class != "NULL") %>%
  ggplot() + geom_point(mapping=aes(x=sdWinRate, y=sdPickBanRate, color = Class)) + facet_wrap(~ Role) + xlab("Standard Deviation of Win Rate") + ylab("Standard Deviation of Pick Ban Rate") + ggtitle("Volatility of Champions")
```


```{r, fig.height = 8}

#Win rate and Pick Ban Rate over time seperated by Role
PatchRoleStats <- leaguedfRole %>% filter(Role != "Jungle") %>%
  group_by(Role, Patch) %>%
  summarize(meanWinRate = mean(WinRate), meanPBRate = mean(PickBanRate),.groups='keep')

plot1a <- leaguedfRole %>% filter(Role != "Jungle") %>%
  ggplot() + geom_line(mapping=aes(x=Patch, y=WinRate, color=Name, alpha=0.001)) +
  geom_line(data = PatchRoleStats, mapping = aes(x=Patch, y=meanWinRate), color="black")+ 
  theme(legend.position="none") + facet_wrap( ~ Role) + ggtitle("Win Rate over Time seperated by Role") + xlab('') + ylab("")

plot1b <- leaguedfRole %>% filter(Role != "Jungle") %>%
  ggplot() + 
  geom_line(mapping=aes(x=Patch, y=PickBanRate, color=Name, alpha=0.001)) + 
  geom_line(data = PatchRoleStats, mapping=aes(x=Patch, y=meanPBRate), color="black") + 
  theme(legend.position="above") + facet_wrap( ~ Role) + ggtitle("PBRate over Time Seperated by Role") + xlab('') + ylab("")
#Win Rate and Pick Ban Rate over Time for just Heimerdinger seperated by Role
plot2a <- leaguedfRole %>% filter(Name == "Heimerdinger") %>%
  ggplot() + geom_line(mapping = aes(x = Patch, y = WinRate, alpha=0.5), color="green") + 
  geom_line(data = PatchRoleStats, mapping=aes(x=Patch, y=meanWinRate), color="black") + 
  facet_wrap(~ Role) + theme(legend.position="none") + xlab("Patch") + ylab("")

plot2b <- leaguedfRole %>% filter(Name == "Heimerdinger") %>%
  ggplot() + geom_line(mapping = aes(x = Patch, y = PickBanRate), color="green") + 
  geom_line(data = PatchRoleStats, mapping=aes(x=Patch, y=meanPBRate), color="black") + 
  facet_wrap("Role") + theme(legend.position="none") + scale_x_discrete("Patch", labels = 1:24) + ylab('')


patched <- (plot1a & plot1b) / (plot2a & plot2b)
patched
```

Is this useful?????? What do you gain from it??

```{r}
#Covariation of PBR for champions.

Spread_Data <- leaguedf %>% 
  pivot_wider(id_cols = c('Name', 'Role'), names_from='Patch', values_from='PickBanRate') %>%
  mutate(ID = paste(Name, Role, sep='.')) %>%
  select(-c(1,2)) %>%
  na.omit()

NameList = Spread_Data$ID

Spread_Data <- as_tibble(t(Spread_Data)) %>%
  filter(row_number() <= n() - 1) %>%
  mutate_if(is.character, as.numeric)

colnames(Spread_Data) <- NameList
CoVarMat <- as_tibble(cor(Spread_Data))
rownames(CoVarMat) <- colnames(CoVarMat)

CoVarMat %>% select(Senna.SUPPORT, `Tahm Kench.SUPPORT`, Ashe.ADC) %>% filter(!(Senna.SUPPORT == 1)) %>%
  ggplot() + geom_boxplot(mapping = aes(x='', y=), id.method='y') + ylab("Senna Support Covariance") + ggtitle("Covariance Boxplot Example") 
```

```{r, eval=FALSE}
p <- leaguedf %>%
  select("Name", "PickBanRate", "WinRate", "Role", "RoleRate", "Class", "Patch") %>% 
  filter(!(Class == "NULL")) %>%
  ggplot() + geom_point(mapping= aes(x = PickBanRate, y = WinRate, size=RoleRate, color=Class)) + 
  facet_wrap(~ Role) + xlab("Pick Ban Rate") + ylab("Win Rate")
gif <- p + transition_states(Patch, 
                             transition_length = 3, 
                             state_length= 1) + 
  labs(title = "Patch: {closest_state}")
anim <- animate(gif, fps = 30, nframes = 480)
anim
```

```{r, fig.height=8, fig.width=8}
leaguedf %>%
  select("Name", "PickBanRate", "WinRate", "Role", "RoleRate", "Class", "Patch") %>%
  filter(!(Class == "NULL")) %>%
  group_by(Role) %>%
  group_map( ~ plot_ly(data = .,
      x = ~ PickBanRate,
      y = ~ WinRate,
      size = ~ RoleRate,
      frame = ~ Patch,
      color = ~ Class,
      text = ~ Name,
      hoverinfo = "text",
      type = "scatter"
      ), .keep = TRUE) %>%
  subplot(nrows = 2, shareX = TRUE, shareY=TRUE)

```
