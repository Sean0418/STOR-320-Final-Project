---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
library(tidyverse)
library(rvest)
library(httr)
library(stringr)
library(lubridate)
library(selectr)
library(DescTools)
```


```{r}

setwd("C:/Users/bobby/Coding/School/STOR 320/Group Project")
findata <- read.csv("Yahoo_data1.csv")

companylist <- unique(findata$Symbol)
```


```{r}
#' Acquire basic company information.
#' 
#' Extracts and displays basic information relating to a given company in a data frame.
#' 
#' @export
#' @import dplyr
#' @param symbol A character vector specifying the stock symbol of the company of interest.
#' @examples
#' \dontrun 

CompanyInfo <- function(symbol) {
    options(stringsAsFactors = FALSE)
    
    temp_url <- paste("https://www.sec.gov/cgi-bin/browse-edgar?CIK=", symbol,
                 "&owner=exclude&action=getcompany&Find=Search", sep= "")
    ua <- "Mozilla/5.0 (iPad; CPU OS 12_2 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148"
    sapply(temp_url, http_error, config(followlocation = 0L), USE.NAMES = FALSE)
    urlm <- GET(temp_url, add_headers("user-agent" = ua, "Cache-Control" = "no-cache"))
    search.result <- xml2::read_html(urlm)
     
     ##   Generic function to extract info
     ExtractInfo <- function(html.node) {
          info <-
               search.result %>%
               rvest::html_nodes(html.node) %>%
               rvest::html_text()
          return(info)
     }
     
     ##   Acquire company name string
     company.name.raw <-
          ExtractInfo(".companyName") %>%
          strsplit(" CIK")
     
     ##   Error message for function
     if(length(company.name.raw) == 0) {
          stop("invalid company symbol")
     }
     
     ##   Parse company name string
     company.name <- company.name.raw[[1]][1]
     
     ##   Acquire CIK number
     CIK.raw <-
          ExtractInfo(".companyName a") %>%
          strsplit(" ")
     
     CIK <- CIK.raw[[1]][1]
     
     ##   Acquire SIC code
     SIC <- ExtractInfo(".identInfo acronym+ a")
     
     ##   Acquire street address
     street.address <- ExtractInfo(".mailer:nth-child(1) .mailerAddress:nth-child(1)")
     
     ##   Acquire city, state, ZIP
     city.state.raw <- ExtractInfo(".mailer:nth-child(1) .mailerAddress+ .mailerAddress")
     city.state <- sub("\\s+$", "", city.state.raw)
     city.state <- gsub("\n", "", city.state)
     
     ##   Fix problems associated with multiple street address lines
     if(length(city.state) == 2){
          street.address <- paste(street.address, city.state[1])
          city.state <- city.state[2]
     }
     
     ##   Acquire fiscal year end
     company.details <-
          ExtractInfo(".identInfo")
     
     fiscal.year.end <-
          gsub("^.*Fiscal Year End: ", "", company.details) %>%
          substr(1,4)
     
     if(fiscal.year.end == "SIC:"){fiscal.year.end <- NA}      ## Fix in case no fiscal year displayed
     
     ##   Acquire state location
     state <-
          gsub("^.*State location: ", "", company.details) %>%
          substr(1,2)
     
     ##   Acquire state of incorporation
     state.inc <-
          gsub("^.*State of Inc.: ", "", company.details) %>%
          substr(1,2)
     
     if(state.inc == "SI"){state.inc <- NA}       ## Fix in case no incorporation year displayed
     
     ##   Create dataframe
     info.df <- data.frame(state = state, city.state = city.state)
     
     Sys.sleep(0.5)
     return(info.df)
}
```



```{r}
zip_frame <- data.frame(symbol=companylist) %>%
  filter(!(symbol %in% list("APH")))

zip_frame <- bind_cols(zip_frame, map_df(zip_frame$symbol, CompanyInfo)) %>%
  mutate(zip_frame, zip= substr(city.state, str_locate(city.state, "[0-9]+"),nchar(city.state)))
```


```{r}
write.csv(zip_frame, "zipframe.csv", row.names=FALSE)
```

```{r}
```

